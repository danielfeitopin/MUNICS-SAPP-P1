import requests
from datetime import date
import gzip

today = date.today()
url = 'http://localhost:8888/resources/'

log_base = 'server.log'
log_comprimido = 'server.log.' + str(today.year) + '-' + str(today.month) + '-' + str(today.day) + '.'
end_file = '.gz'

# En esta variable almacenaremos los archivos descargados
archivos_descargados = [log_base]

# Descargaremos el fichero server.log
r = requests.get(url + log_base)

with open(log_base,'wb') as f:
    f.write(r.content)
    f.close()
r.close()

# Descargamos los comprimidos del dia de hoy
cnt = 0
continuar = True

while continuar:
    log_filename = log_comprimido + str(cnt) + end_file
    r = requests.get(url + log_filename)
    if (r.status_code == 404):
        continuar = False
        r.close()
    if r.status_code == 200:
        with open(log_filename,'wb') as f:
            f.write(r.content)
            f.close()
        r.close()
        archivos_descargados.append(log_filename)
    cnt +=1

# Analizamos los ficheros en busca de correos electronicos
# Los guardamos en un set para no tener repetidos
for archivo in archivos_descargados:
    lineas = ''
    if archivo[-3:len(archivo)] == '.gz':
        with gzip.open(archivo,'rb') as archivo_gz:
            lineas = archivo_gz.readlines()
            archivo_gz.close()
    else:
        with open(archivo,'rb') as archivo:
            lineas = archivo.readlines()
            archivo.close()
    for linea in lineas:
        if linea.count(b'@') > 0:
            print(linea.decode('utf-8'),end='')
